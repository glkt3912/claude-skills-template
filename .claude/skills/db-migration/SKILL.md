---
name: db-migration
description: データベースマイグレーションを作成する。「マイグレーション作成」「テーブル追加」「カラム変更」などの依頼時に使用。
---

# 目的

安全で可逆的なデータベースマイグレーションファイルを作成する。

# 手順

1. **変更内容の確認**
   - 追加/変更/削除するテーブル・カラム
   - データ移行の必要性

2. **既存スキーマの確認**
   - 現在のテーブル構造を把握
   - 外部キー制約、インデックスを確認

3. **マイグレーション作成**
   - up（適用）と down（ロールバック）を両方記述
   - 本番環境でのリスクを考慮

4. **検証**
   - up/down の両方が正しく動作するか
   - データ整合性が保たれるか

# 安全なマイグレーションのルール

| ルール | 説明 |
| ------ | ---- |
| 後方互換性 | 旧コードと新コードが共存できる変更 |
| 段階的変更 | 大きな変更は複数のマイグレーションに分割 |
| ロールバック可能 | down マイグレーションを必ず用意 |
| データ保護 | 既存データを破壊しない |

# 危険な操作と安全な代替

| 危険な操作 | 安全な代替 |
| ---------- | ---------- |
| カラム削除 | 1. コードから参照を削除 → 2. 後日カラム削除 |
| カラム名変更 | 1. 新カラム追加 → 2. データコピー → 3. コード更新 → 4. 旧カラム削除 |
| NOT NULL 追加 | 1. デフォルト値付きで追加 → 2. 既存データ更新 → 3. デフォルト削除 |

# テンプレート（Prisma 形式）

```prisma
// schema.prisma の変更例
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  // 新しく追加するカラム
  role      String   @default("user")
}
```

# テンプレート（SQL 形式）

```sql
-- Up
ALTER TABLE users ADD COLUMN role VARCHAR(50) DEFAULT 'user';

-- Down
ALTER TABLE users DROP COLUMN role;
```

# 制約

- 本番環境では必ずバックアップを取得
- 大量データの更新はバッチ処理を検討
- ロック時間を最小限に
