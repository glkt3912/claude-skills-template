---
name: db-migration
description: データベースマイグレーションを作成する。「マイグレーション作成」「テーブル追加」「カラム変更」などの依頼時に使用。
---

# 目的

安全で可逆的なデータベースマイグレーションファイルを作成する。

# 手順

1. **変更内容の確認**
   - 追加/変更/削除するテーブル・カラム

2. **既存スキーマの確認**
   - 現在のテーブル構造を把握

3. **マイグレーション作成**
   - `references/safe-migrations.md` に従う
   - up と down を両方記述

4. **検証**
   - up/down の両方が正しく動作するか

# 基本フォーマット

```sql
-- Up
ALTER TABLE users ADD COLUMN role VARCHAR(50) DEFAULT 'user';

-- Down
ALTER TABLE users DROP COLUMN role;
```

# 安全なマイグレーションのルール

| ルール | 説明 |
| ------ | ---- |
| 後方互換性 | 旧コードと新コードが共存できる |
| 段階的変更 | 大きな変更は複数に分割 |
| ロールバック可能 | down を必ず用意 |
| データ保護 | 既存データを破壊しない |

# 参照

- `references/safe-migrations.md` - 安全なマイグレーションガイド

# 制約

- 本番環境では必ずバックアップを取得
- 大量データの更新はバッチ処理
- ロック時間を最小限に
